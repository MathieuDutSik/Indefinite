#!/usr/bin/perl -w

use Cwd;

$TheDirPWD = getcwd;
print "TheDirPWD=".$TheDirPWD."\n";

open(INFILE, "../../sysinfo.gap") or die "cannot found ../../sysinfo.gap";
@BU=<INFILE>;
close(INFILE);

my $nbSYS=scalar(@BU);
my $arch = "unset";
for (my $i_line=0; $i_line<$nbSYS; $i_line++)
{
    $_ = $BU[$i_line];
    chomp($_);
    $e_line = $_;
    #
    my @HS=split("=", $_);
    if (scalar(@HS) eq 2)
    {
        if ($HS[0] eq "GAParch")
        {
            $arch = $HS[1];
        }
    }
}

if ($arch eq "unset")
{
    die "Failed to find arch";
}
print "arch=".$arch."\n";

$order="mkdir -p bin/".$arch;
print "order=".$order."\n";
if (system($order) != 0) {
    die "impossible to create the bin directory\n";
}

$order="mkdir -p ExternalProg/Binaries";
print "order=".$order."\n";
if (system($order) != 0) {
    die "impossible to run the mkdir operation\n";
}

#
# Now the package specific compilations
#

$order="./InstallScript/INSTALL_AUTOISOM";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_AUTOISOM";
}


$order="./InstallScript/INSTALL_cdd";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_cdd";
}


$order="./InstallScript/INSTALL_cdd_QN";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_cdd_QN";
}


$order="./InstallScript/INSTALL_lrs";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_lrs";
}


$order="./InstallScript/INSTALL_nauty";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_nauty";
}


$order="./InstallScript/INSTALL_NegativeVect";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_NegativeVect";
}


$order="./InstallScript/INSTALL_sv";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_sv";
}


$order="./InstallScript/INSTALL_polyhedral_common";
print "order=".$order."\n";
if (system($order) != 0) {
    die "Impossible to run the installscript InstallScript/INSTALL_polyhedral_common";
}


#
# First the binaries
#

my $eListProg="/tmp/ListProg_Binaries";

$order="ls ExternalProg/Binaries/ > ".$eListProg;
print $order."\n";
if (system($order) != 0) {
   die "Impossible to do ls\n";
}

open(INF, $eListProg) or die "impossible to open ".$eListProg;
while(<INF>)
{
    chomp($_);
    $order="(cd bin/".$arch." && ln -s ../../ExternalProg/Binaries/".$_." .)";
    print $order."\n";
    if (system($order) != 0) {
        die "Impossible to make the link for the binaries\n";
    }
}
close(INF);

$order="rm -f ".$eListProg;
print $order."\n";
if (system($order) != 0) {
   die "Impossible to remove ListProg file\n";
}

#
# Now the perlscripts links
#

my $eListPerl="/tmp/ListProg_PerlScript";

$order="ls PerlScript/ > ".$eListPerl;
print $order."\n";
if (system($order) != 0) {
    die "Impossible to do ls\n";
}

open(INF, $eListPerl) or die "impossible to open ".$eListPerl;
while(<INF>)
{
    chomp($_);
    $order="(cd bin/".$arch." && ln -s ../../PerlScript/".$_." .)";
    print $order."\n";
    if (system($order) != 0) {
        die "Impossible to make the link for the perl scripts\n";
    }
}
close(INF);

$order="rm -f ".$eListPerl;
print $order."\n";
if (system($order) != 0) {
   die "Impossible to remove ListProg file\n";
}
